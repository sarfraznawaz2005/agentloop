<Window x:Class="AgentLoop.UI.Views.SettingsDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:AgentLoop.UI.ViewModels"
        xmlns:fa="clr-namespace:FontAwesome.Sharp;assembly=FontAwesome.Sharp"
        Title="Settings"
        Width="650" Height="680"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize"
        Style="{StaticResource ModernWindow}">
    <Window.DataContext>
        <vm:SettingsViewModel/>
    </Window.DataContext>
    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <!-- Agent Section -->
                <GroupBox Header="Agent" Style="{StaticResource CardGroupBox}">
                    <StackPanel>
                        <TextBlock Text="Setup Method" Style="{StaticResource SectionLabel}"/>
                        <StackPanel Orientation="Horizontal" Margin="0,4,0,12">
                            <RadioButton Content="Choose from list" 
                                         IsChecked="{Binding IsPredefinedAgent}" 
                                         Style="{StaticResource ModernRadioButton}"
                                         Margin="0,0,24,0"/>
                            <RadioButton Content="Custom command" 
                                         IsChecked="{Binding IsCustomCommand}" 
                                         Style="{StaticResource ModernRadioButton}"/>
                        </StackPanel>

                        <!-- Predefined List -->
                        <StackPanel Visibility="{Binding IsPredefinedAgent, Converter={StaticResource BoolToVisibility}}" Margin="0,0,0,12">
                            <TextBlock Text="Select Agent" Style="{StaticResource SectionLabel}"/>
                            <ComboBox Style="{StaticResource ModernComboBox}"
                                      ItemsSource="{Binding PredefinedAgents}"
                                      SelectedItem="{Binding SelectedAgent}"
                                      DisplayMemberPath="Name"
                                      Margin="0,0,0,12"/>
                            
                            <TextBlock Text="Agent Command (Editable)" Style="{StaticResource SectionLabel}"/>
                            <TextBox Style="{StaticResource ModernTextBox}"
                                     Text="{Binding PredefinedAgentCommand, UpdateSourceTrigger=PropertyChanged}"
                                     FontFamily="{StaticResource MonoFont}"/>
                            <TextBlock Text="The command is pre-filled with recommended flags."
                                       FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,4,0,0"/>
                        </StackPanel>

                        <!-- Custom Input -->
                        <StackPanel Visibility="{Binding IsCustomCommand, Converter={StaticResource BoolToVisibility}}" Margin="0,0,0,12">
                            <TextBlock Text="Enter Agent Command" Style="{StaticResource SectionLabel}"/>
                            <TextBox Style="{StaticResource ModernTextBox}"
                                     Text="{Binding CustomAgentCommand, UpdateSourceTrigger=PropertyChanged}"
                                     FontFamily="{StaticResource MonoFont}"/>
                            <TextBlock Text="Use {prompt} as a placeholder for your job prompts."
                                       FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,4,0,0"/>
                        </StackPanel>

                        <!-- Test Button & Loading -->
                        <Grid Margin="0,4,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel Grid.Column="0" VerticalAlignment="Center" 
                                        Visibility="{Binding IsTesting, Converter={StaticResource BoolToVisibility}}">
                                <TextBlock Text="Testing command..." Foreground="{StaticResource TextSecondaryBrush}" FontSize="11"/>
                            </StackPanel>

                            <Button Grid.Column="1" Style="{StaticResource SecondaryButton}"
                                    Command="{Binding TestCommand}" Margin="12,0,0,0" MinWidth="0" Padding="12,4">
                                <StackPanel Orientation="Horizontal">
                                    <fa:IconBlock Icon="Vial" Style="{StaticResource ButtonIcon}" FontSize="12"/>
                                    <TextBlock Text="Test Command" FontSize="12"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <!-- Test Result -->
                        <Border Background="{StaticResource HoverBrush}" CornerRadius="6"
                                Padding="10" Margin="0,12,0,0"
                                Visibility="{Binding HasTestResult, Converter={StaticResource BoolToVisibility}}">
                            <StackPanel>
                                <TextBlock FontWeight="SemiBold" Margin="0,0,0,4">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="Test Failed"/>
                                            <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding TestSuccess}" Value="True">
                                                    <Setter Property="Text" Value="Test Passed"/>
                                                    <Setter Property="Foreground" Value="{StaticResource AccentBrush}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                <TextBox Text="{Binding TestResult, Mode=OneWay}"
                                         IsReadOnly="True"
                                         TextWrapping="Wrap"
                                         MaxHeight="100"
                                         BorderThickness="0"
                                         Background="Transparent"
                                         FontFamily="{StaticResource MonoFont}"
                                         FontSize="11"
                                         VerticalScrollBarVisibility="Auto"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </GroupBox>

                <!-- Notifications Section -->
                <GroupBox Header="Notifications" Style="{StaticResource CardGroupBox}">
                    <StackPanel>
                        <CheckBox Content="Show notification on job success"
                                  Style="{StaticResource ModernCheckBox}"
                                  IsChecked="{Binding NotificationOnSuccess}"
                                  Margin="0,0,0,8"/>
                        <CheckBox Content="Show notification on job failure"
                                  Style="{StaticResource ModernCheckBox}"
                                  IsChecked="{Binding NotificationOnFailure}"/>
                    </StackPanel>
                </GroupBox>

                <!-- Logs Section -->
                <GroupBox Header="Logs" Style="{StaticResource CardGroupBox}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,12,12">
                            <TextBlock Text="Max log file size (MB)" Style="{StaticResource SectionLabel}"/>
                            <TextBox Style="{StaticResource ModernTextBox}"
                                     Text="{Binding LogMaxSizeMb}" Width="80" HorizontalAlignment="Left"/>
                        </StackPanel>

                        <StackPanel Grid.Row="0" Grid.Column="1" Margin="0,0,0,12">
                            <TextBlock Text="Log retention (days)" Style="{StaticResource SectionLabel}"/>
                            <TextBox Style="{StaticResource ModernTextBox}"
                                     Text="{Binding LogRetentionDays}" Width="80" HorizontalAlignment="Left"/>
                        </StackPanel>

                        <StackPanel Grid.Row="1" Grid.ColumnSpan="2">
                            <TextBlock Text="Logs directory:" Style="{StaticResource SectionLabel}"/>
                            <TextBlock Text="{Binding LogsDirectory}" Foreground="{StaticResource TextSecondaryBrush}"
                                       FontSize="11" TextWrapping="Wrap"/>
                        </StackPanel>
                    </Grid>
                </GroupBox>

                <!-- Results Section -->
                <GroupBox Header="Results" Style="{StaticResource CardGroupBox}">
                    <StackPanel>
                        <TextBlock Text="Automatic Result Saving" Style="{StaticResource SectionLabel}"/>
                        <TextBlock Text="Results will be saved as .txt files in categorized subfolders by job name."
                                   FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,12"/>
                        
                        <TextBlock Text="Save directory:" Style="{StaticResource SectionLabel}"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" Style="{StaticResource ModernTextBox}"
                                     Text="{Binding ResultsDirectory}" IsReadOnly="True"
                                     VerticalAlignment="Center"/>
                            <Button Grid.Column="1" Style="{StaticResource SecondaryButton}"
                                    Command="{Binding BrowseResultsDirectoryCommand}"
                                    Margin="8,0,0,0" Padding="12,4" MinWidth="0">
                                <fa:IconBlock Icon="FolderOpen" FontSize="14"/>
                            </Button>
                        </Grid>
                    </StackPanel>
                </GroupBox>

                <!-- Application Section -->
                <GroupBox Header="Application" Style="{StaticResource CardGroupBox}">
                    <StackPanel>
                        <CheckBox Content="Start with Windows"
                                  Style="{StaticResource ModernCheckBox}"
                                  IsChecked="{Binding StartWithWindows}"
                                  Margin="0,0,0,8"/>
                        
                        <CheckBox Content="Start minimized to system tray"
                                  Style="{StaticResource ModernCheckBox}"
                                  IsChecked="{Binding StartMinimizedToTray}"
                                  Margin="0,0,0,12"/>

                        <TextBlock Text="Task Scheduler folder:" Style="{StaticResource SectionLabel}"/>
                        <TextBlock Foreground="{StaticResource TextSecondaryBrush}" FontSize="11">
                            <Run Text="\"/>
                            <Run Text="{Binding TaskFolder, Mode=OneWay}"/>
                        </TextBlock>
                    </StackPanel>
                </GroupBox>

                <!-- Debug Section -->
                <GroupBox Header="Debug" Style="{StaticResource CardGroupBox}">
                    <StackPanel>
                        <CheckBox Content="Enable debug mode (logs app actions to app.log)"
                                  Style="{StaticResource ModernCheckBox}"
                                  IsChecked="{Binding DebugMode}"
                                  Margin="0,0,0,12"/>

                        <TextBlock Text="Log files:" Style="{StaticResource SectionLabel}"/>
                        <TextBlock FontSize="11" Foreground="{StaticResource TextSecondaryBrush}">
                            <Run Text="App log: "/>
                            <Run Text="{Binding AppLogPath, Mode=OneWay}"/>
                        </TextBlock>
                    </StackPanel>
                </GroupBox>
            </StackPanel>
        </ScrollViewer>

        <!-- Buttons -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,16,0,0">
            <Button Style="{StaticResource SecondaryButton}"
                    Command="{Binding ResetDefaultsCommand}" Margin="0,0,8,0">
                <StackPanel Orientation="Horizontal">
                    <fa:IconBlock Icon="Undo" Style="{StaticResource ButtonIcon}"/>
                    <TextBlock Text="Reset Defaults"/>
                </StackPanel>
            </Button>
            <Button Style="{StaticResource SecondaryButton}"
                    Command="{Binding CancelCommand}" Margin="0,0,8,0">
                <StackPanel Orientation="Horizontal">
                    <fa:IconBlock Icon="Times" Style="{StaticResource ButtonIcon}"/>
                    <TextBlock Text="Cancel"/>
                </StackPanel>
            </Button>
            <Button Style="{StaticResource PrimaryButton}"
                    Command="{Binding SaveCommand}">
                <StackPanel Orientation="Horizontal">
                    <fa:IconBlock Icon="Save" Style="{StaticResource ButtonIcon}"/>
                    <TextBlock Text="Save"/>
                </StackPanel>
            </Button>
        </StackPanel>
    </Grid>
</Window>
