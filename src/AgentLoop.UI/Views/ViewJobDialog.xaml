<Window x:Class="AgentLoop.UI.Views.ViewJobDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:fa="clr-namespace:FontAwesome.Sharp;assembly=FontAwesome.Sharp"
        xmlns:models="clr-namespace:AgentLoop.Data.Models;assembly=AgentLoop.Data"
        xmlns:helpers="clr-namespace:AgentLoop.UI.Helpers"
        Title="{Binding JobName, StringFormat='View Job: {0}'}"
        Width="800" Height="650"
        WindowStartupLocation="CenterScreen"
        Style="{StaticResource ModernWindow}">
    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Job Details Header -->
        <Border Grid.Row="0" Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="1"
                CornerRadius="8" Padding="20" Margin="0,0,0,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Job Name -->
                <TextBlock Grid.Row="0" Grid.Column="0" Text="{Binding JobName}"
                           Style="{StaticResource Heading}" Margin="0,0,0,8"/>

                <!-- Prompt -->
                <TextBlock Grid.Row="1" Grid.Column="0" Text="{Binding Prompt, Converter={StaticResource SingleLine}}"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" 
                           MaxHeight="20" Margin="0,0,0,12"/>

                <!-- Agent Override -->
                <StackPanel Grid.Row="2" Grid.Column="0" Orientation="Horizontal" Margin="0,0,0,4"
                            Visibility="{Binding AgentOverride, Converter={StaticResource NullToVisibility}}">
                    <TextBlock Text="Agent: " FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding AgentOverride}" Foreground="{StaticResource PrimaryBrush}"/>
                </StackPanel>

                <!-- Schedule -->
                <StackPanel Grid.Row="3" Grid.Column="0" Orientation="Horizontal" Margin="0,0,0,4">
                    <TextBlock Text="Schedule: " FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding ScheduleDescription}"/>
                </StackPanel>

                <!-- Next/Last Run -->
                <StackPanel Grid.Row="4" Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Next Run: " FontWeight="SemiBold" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding NextRun, Converter={StaticResource Countdown}}"
                               Foreground="{StaticResource PrimaryBrush}" Margin="0,0,20,0" VerticalAlignment="Center"/>
                    <TextBlock Text="Last Run: " FontWeight="SemiBold" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding LastRun, Converter={StaticResource RelativeTime}}" VerticalAlignment="Center"/>
                    <Ellipse Width="8" Height="8" Margin="6,0,0,0" VerticalAlignment="Center">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Setter Property="Fill" Value="{StaticResource TextDisabledBrush}"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding LastStatus}" Value="{x:Static models:JobStatus.Success}">
                                        <Setter Property="Fill" Value="{StaticResource AccentBrush}"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding LastStatus}" Value="{x:Static models:JobStatus.Failure}">
                                        <Setter Property="Fill" Value="{StaticResource ErrorBrush}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                </StackPanel>

                <!-- Stats -->
                <Border Grid.Row="0" Grid.RowSpan="4" Grid.Column="1"
                        Background="{StaticResource BackgroundBrush}"
                        CornerRadius="8" Padding="16" VerticalAlignment="Center">
                    <StackPanel>
                        <TextBlock Text="Statistics" FontWeight="SemiBold" Margin="0,0,0,8"/>
                        <StackPanel Orientation="Horizontal">
                            <StackPanel Margin="0,0,16,0" HorizontalAlignment="Center">
                                <TextBlock Text="{Binding TotalRuns}" FontSize="24" FontWeight="Bold"
                                           HorizontalAlignment="Center"/>
                                <TextBlock Text="Total" Foreground="{StaticResource TextSecondaryBrush}"
                                           FontSize="11" HorizontalAlignment="Center"/>
                            </StackPanel>
                            <StackPanel Margin="0,0,16,0" HorizontalAlignment="Center">
                                <TextBlock Text="{Binding SuccessCount}" FontSize="24" FontWeight="Bold"
                                           Foreground="{StaticResource AccentBrush}" HorizontalAlignment="Center"/>
                                <TextBlock Text="Success" Foreground="{StaticResource TextSecondaryBrush}"
                                           FontSize="11" HorizontalAlignment="Center"/>
                            </StackPanel>
                            <StackPanel HorizontalAlignment="Center">
                                <TextBlock Text="{Binding FailedCount}" FontSize="24" FontWeight="Bold"
                                           Foreground="{StaticResource ErrorBrush}" HorizontalAlignment="Center"/>
                                <TextBlock Text="Failed" Foreground="{StaticResource TextSecondaryBrush}"
                                           FontSize="11" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- Run History Header -->
        <Grid Grid.Row="1" Margin="0,0,0,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Grid.Column="0" VerticalAlignment="Center">
                <Run Text="Run History" FontWeight="SemiBold" FontSize="15"/>
                <Run Text=" (" Foreground="{StaticResource TextSecondaryBrush}"/>
                <Run Text="{Binding TotalLogCount, Mode=OneWay}" Foreground="{StaticResource TextSecondaryBrush}"/>
                <Run Text=")" Foreground="{StaticResource TextSecondaryBrush}"/>
            </TextBlock>
            <ComboBox Grid.Column="1" Style="{StaticResource ModernComboBox}"
                      Width="110" Height="28" FontSize="12"
                      Padding="8,4"
                      SelectedValue="{Binding LogFilter}"
                      SelectedValuePath="Content" Margin="0,0,8,0"
                      VerticalAlignment="Center">
                <ComboBoxItem Content="All"/>
                <ComboBoxItem Content="Success"/>
                <ComboBoxItem Content="Failed"/>
                <ComboBoxItem Content="Favorites"/>
            </ComboBox>
            <Button Grid.Column="2" Style="{StaticResource SecondaryButton}"
                    Command="{Binding ClearAllCommand}"
                    Padding="10,4" MinWidth="0" MinHeight="0">
                <StackPanel Orientation="Horizontal">
                    <fa:IconBlock Icon="TrashAlt" Style="{StaticResource ButtonIcon}"/>
                    <TextBlock Text="Clear All"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- Run History List -->
        <Border Grid.Row="2" Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="1"
                CornerRadius="8">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <ListView x:Name="RunHistoryList"
                          Grid.Row="0" ItemsSource="{Binding FilteredLogs}"
                          SelectedItem="{Binding SelectedLog}"
                          BorderThickness="0" Background="Transparent"
                          GridViewColumnHeader.Click="GridViewColumnHeader_Click"
                          helpers:GridViewColumnStretch.Enabled="True"
                          MouseDoubleClick="RunHistoryList_MouseDoubleClick"
                          KeyDown="RunHistoryList_KeyDown">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem" BasedOn="{StaticResource ListViewItemStyle}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                    <Setter Property="Background" Value="{StaticResource FavoriteBrush}"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.View>
                        <GridView ColumnHeaderContainerStyle="{StaticResource GridViewColumnHeader}">
                            <GridViewColumn Width="60" helpers:GridViewColumnSort.SortPropertyName="Status">
                                <GridViewColumn.Header>
                                    <TextBlock Text="Status" HorizontalAlignment="Stretch" TextAlignment="Center"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid Height="20" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0">
                                            <Ellipse Width="10" Height="10" HorizontalAlignment="Center" VerticalAlignment="Center">
                                                <Ellipse.Style>
                                                    <Style TargetType="Ellipse">
                                                        <Setter Property="Fill" Value="{StaticResource AccentBrush}"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Status}" Value="{x:Static models:JobStatus.Failure}">
                                                                <Setter Property="Fill" Value="{StaticResource ErrorBrush}"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Ellipse.Style>
                                            </Ellipse>
                                        </Grid>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn Width="280" helpers:GridViewColumnSort.SortPropertyName="StartTime" helpers:GridViewColumnStretch.StretchColumn="True">
                                <GridViewColumn.Header>
                                    <TextBlock Text="Start Time" HorizontalAlignment="Stretch" TextAlignment="Center"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid Height="20" VerticalAlignment="Center" HorizontalAlignment="Center">
                                            <TextBlock Text="{Binding StartTime, StringFormat='{}{0:MMM dd, yyyy HH:mm}'}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" FontSize="12" TextAlignment="Center"/>
                                        </Grid>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn Width="85" helpers:GridViewColumnSort.SortPropertyName="DurationSeconds">
                                <GridViewColumn.Header>
                                    <TextBlock Text="Duration" HorizontalAlignment="Stretch" TextAlignment="Center"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid Height="20" VerticalAlignment="Center" HorizontalAlignment="Center">
                                            <TextBlock Text="{Binding DurationSeconds, StringFormat='{}{0:F1}s'}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" FontSize="12" TextAlignment="Center"/>
                                        </Grid>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn Width="90" helpers:GridViewColumnSort.SortPropertyName="StartTime">
                                <GridViewColumn.Header>
                                    <TextBlock Text="Ago" HorizontalAlignment="Stretch" TextAlignment="Center"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid Height="20" VerticalAlignment="Center" HorizontalAlignment="Center">
                                            <TextBlock Text="{Binding StartTime, Converter={StaticResource RelativeTime}}" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" FontSize="12" TextAlignment="Center"/>
                                        </Grid>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn Width="150">
                                <GridViewColumn.Header>
                                    <TextBlock Text="Actions" HorizontalAlignment="Stretch" TextAlignment="Center"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid Height="20" VerticalAlignment="Center">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Center">
                                                <Button Style="{StaticResource IconButton}"
                                                        Padding="6,2" MinWidth="0" MinHeight="0"
                                                        Command="{Binding DataContext.ViewLogCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"
                                                        Margin="0,0,4,0"
                                                        ToolTip="View Log">
                                                    <fa:IconBlock Icon="Eye" FontSize="12" Foreground="#1a73e8"/>
                                                </Button>
                                                <Button Style="{StaticResource IconButton}"
                                                        Padding="6,2" MinWidth="0" MinHeight="0"
                                                        Command="{Binding DataContext.RerunCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"
                                                        Margin="0,0,4,0"
                                                        ToolTip="Rerun">
                                                    <fa:IconBlock Icon="Redo" FontSize="12" Foreground="#34a853"/>
                                                </Button>
                                                <Button Style="{StaticResource IconButton}"
                                                        Padding="6,2" MinWidth="0" MinHeight="0"
                                                        Command="{Binding DataContext.ToggleFavoriteCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"
                                                        Margin="0,0,4,0"
                                                        ToolTip="Favorite">
                                                    <fa:IconBlock FontSize="12">
                                                        <fa:IconBlock.Style>
                                                            <Style TargetType="fa:IconBlock">
                                                                <Setter Property="Icon" Value="Heart"/>
                                                                <Setter Property="IconFont" Value="Regular"/>
                                                                <Setter Property="Foreground" Value="{StaticResource TextDisabledBrush}"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                                        <Setter Property="IconFont" Value="Solid"/>
                                                                        <Setter Property="Foreground" Value="#e91e63"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </fa:IconBlock.Style>
                                                    </fa:IconBlock>
                                                </Button>
                                                <Button Style="{StaticResource IconButton}"
                                                        Padding="6,2" MinWidth="0" MinHeight="0"
                                                        Command="{Binding DataContext.DeleteLogCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"
                                                        IsEnabled="{Binding IsFavorite, Converter={StaticResource InverseBool}}"
                                                        ToolTip="Delete">
                                                    <fa:IconBlock Icon="Trash" FontSize="12" Foreground="#ea4335"/>
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                        </GridView>
                    </ListView.View>
                </ListView>

                <TextBlock Grid.Row="0"
                           Text="No logs yet"
                           Foreground="{StaticResource TextDisabledBrush}"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Visibility="{Binding FilteredLogs.Count, Converter={StaticResource CountToVisibility}, ConverterParameter=Invert}"/>

                <Border Grid.Row="1" Padding="12" Visibility="{Binding HasMoreLogs, Converter={StaticResource BoolToVisibility}}">
                    <Button Style="{StaticResource SecondaryButton}"
                            Command="{Binding LoadMoreCommand}"
                            Click="LoadMore_Click"
                            HorizontalAlignment="Center">
                        <StackPanel Orientation="Horizontal">
                            <fa:IconBlock Icon="ChevronDown" Style="{StaticResource ButtonIcon}"/>
                            <TextBlock Text="Load More"/>
                        </StackPanel>
                    </Button>
                </Border>
            </Grid>
        </Border>

        <!-- Bottom Buttons -->
        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,16,0,0">
            <Button Style="{StaticResource SecondaryButton}"
                    Command="{Binding BackCommand}">
                <StackPanel Orientation="Horizontal">
                    <fa:IconBlock Icon="Times" Style="{StaticResource ButtonIcon}"/>
                    <TextBlock Text="Close"/>
                </StackPanel>
            </Button>
        </StackPanel>
    </Grid>
</Window>
